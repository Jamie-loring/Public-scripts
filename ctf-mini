#!/bin/bash

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Logging
log_info() { echo -e "${GREEN}[+]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[-]${NC} $1"; }
log_progress() { echo -e "${BLUE}[*]${NC} $1"; }

# Capture original user
ORIGINAL_USER="${SUDO_USER:-$USER}"
[[ "$ORIGINAL_USER" == "root" ]] && ORIGINAL_USER=""

# Username validation
validate_username() {
  local username="$1"
  if [[ ! "$username" =~ ^[a-z_][a-z0-9_-]{0,31}$ ]]; then
    log_error "Invalid username format"
    return 1
  fi
  local reserved=("root" "daemon" "bin" "sys" "sync" "games" "man" "lp" "mail" "news" "uucp" "proxy" "www-data" "backup" "list" "irc" "nobody")
  for reserved_name in "${reserved[@]}"; do
    [[ "$username" == "$reserved_name" ]] && log_error "Cannot use reserved username: $username" && return 1
  done
  return 0
}

# Welcome and username setup
clear
echo -e "${CYAN}"
cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—     â•‘
â•‘    â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•     â•‘
â•‘    â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•      â•‘
â•‘    â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•”â•â•â•      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—      â•‘
â•‘    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—     â•‘
â•‘     â•šâ•â•â•â•â•â•    â•šâ•â•  â•šâ•â•         â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•     â•‘
â•‘                                                               â•‘
â•‘            PENTESTING TOOLKIT INSTALLER                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}\n"

DEFAULT_USERNAME="$USER"
while true; do
  read -p "Enter pentesting username [default: $DEFAULT_USERNAME]: " USERNAME
  USERNAME="${USERNAME:-$DEFAULT_USERNAME}"
  validate_username "$USERNAME" && break
done

export USERNAME
export USER_HOME="/home/$USERNAME"

log_info "Username: ${GREEN}$USERNAME${NC}"
echo ""
log_warn "This will install EVERYTHING (takes 10-30 minutes)"
read -p "Continue? (y/n): " confirm
[[ "$confirm" != "y" ]] && [[ "$confirm" != "Y" ]] && exit 0

# ============================================
# PHASE 1: SYSTEM SETUP
# ============================================
log_progress "Phase 1: System Updates & Base Packages"
DEBIAN_FRONTEND=noninteractive apt update -qq
DEBIAN_FRONTEND=noninteractive apt upgrade -y -qq

DEBIAN_FRONTEND=noninteractive apt install -y -qq \
  build-essential git curl wget vim neovim tmux zsh \
  python3-pip python3-venv golang-go rustc cargo \
  docker.io docker-compose jq ripgrep fd-find bat \
  htop ncdu tree fonts-powerline silversearcher-ag \
  2>&1 | tee -a /var/log/ctfbox-install.log

# ============================================
# PHASE 2: USER SETUP
# ============================================
log_progress "Phase 2: User Account Configuration"

if ! id "$USERNAME" &>/dev/null; then
  useradd -m -s /bin/zsh -G sudo,docker "$USERNAME"
  echo "$USERNAME:''" | chpasswd -e
  log_info "User '$USERNAME' created"
else
  log_info "User '$USERNAME' already exists"
fi

echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/"$USERNAME"
chmod 440 /etc/sudoers.d/"$USERNAME"

chown -R "$USERNAME":"$USERNAME" "$USER_HOME" 2>/dev/null || true
chsh -s "$(which zsh)" "$USERNAME" 2>/dev/null || true

# Auto-login configuration
echo ""
read -p "Enable auto-login for $USERNAME and disable $ORIGINAL_USER? (y/n): " auto_login
if [[ "$auto_login" =~ ^[Yy]$ ]]; then
  log_progress "Configuring auto-login for $USERNAME..."
  
  # LightDM
  if [[ -d "/etc/lightdm" ]]; then
    mkdir -p /etc/lightdm/lightdm.conf.d
    cat > /etc/lightdm/lightdm.conf.d/50-autologin.conf << EOF
[Seat:*]
autologin-user=$USERNAME
autologin-user-timeout=0
user-session=default
allow-guest=false
autologin-guest=false
EOF
    log_info "LightDM auto-login configured"
  fi
  
  # GDM3
  if [[ -f "/etc/gdm3/custom.conf" ]]; then
    if ! grep -q '^\[daemon\]' /etc/gdm3/custom.conf; then
      echo -e "\n[daemon]" >> /etc/gdm3/custom.conf
    fi
    sed -i '/AutomaticLoginEnable/d' /etc/gdm3/custom.conf
    sed -i '/AutomaticLogin/d' /etc/gdm3/custom.conf
    sed -i '/TimedLoginEnable/d' /etc/gdm3/custom.conf
    sed -i '/TimedLogin/d' /etc/gdm3/custom.conf
    sed -i '/TimedLoginDelay/d' /etc/gdm3/custom.conf
    sed -i '/^\[daemon\]/a AutomaticLoginEnable = true' /etc/gdm3/custom.conf
    sed -i "/^AutomaticLoginEnable/a AutomaticLogin = $USERNAME" /etc/gdm3/custom.conf
    sed -i '/^\[daemon\]/a TimedLoginEnable = true' /etc/gdm3/custom.conf
    sed -i "/^TimedLoginEnable/a TimedLogin = $USERNAME" /etc/gdm3/custom.conf
    sed -i "/^TimedLogin = $USERNAME/a TimedLoginDelay = 0" /etc/gdm3/custom.conf
    log_info "GDM3 auto-login configured"
  fi
  
  # SDDM
  if [[ -f "/etc/sddm.conf" ]] || [[ -d "/etc/sddm.conf.d" ]]; then
    mkdir -p /etc/sddm.conf.d
    cat > /etc/sddm.conf.d/autologin.conf << EOF
[Autologin]
User=$USERNAME
Session=plasma.desktop
EOF
    log_info "SDDM auto-login configured"
  fi
  
  # Clear old user's session cache
  if [[ -n "$ORIGINAL_USER" ]] && [[ -d "/home/$ORIGINAL_USER/.cache" ]]; then
    rm -rf /home/"$ORIGINAL_USER"/.cache/sessions/* 2>/dev/null || true
  fi
  
  log_info "Auto-login configured for $USERNAME"
fi

# Passwordless login group
if ! grep -q '^nopasswdlogin:' /etc/group; then
  groupadd nopasswdlogin
fi
usermod -aG nopasswdlogin "$USERNAME"

if ! grep -q 'pam_succeed_if.so user ingroup nopasswdlogin' /etc/pam.d/common-auth; then
  sed -i '/^auth.*pam_deny.so/i auth\t[success=1 default=ignore]\tpam_succeed_if.so user ingroup nopasswdlogin' /etc/pam.d/common-auth
fi

# ============================================
# PHASE 3: SHELL ENVIRONMENT
# ============================================
log_progress "Phase 3: Shell Environment (Zsh + Oh-My-Zsh + p10k)"

TEMP_HOME="/tmp/user-setup-$USERNAME"
rm -rf "$TEMP_HOME" 2>/dev/null || true
mkdir -p "$TEMP_HOME"

export HOME="$TEMP_HOME"
sh -c "RUNZSH=no $(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended 2>&1 | tee -a /var/log/ctfbox-install.log
export HOME="/root"

git clone https://github.com/zsh-users/zsh-autosuggestions "${TEMP_HOME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions" 2>/dev/null || true
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "${TEMP_HOME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting" 2>/dev/null || true
git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${TEMP_HOME}/.oh-my-zsh/custom/themes/powerlevel10k" 2>/dev/null || true

wget -q https://raw.githubusercontent.com/Jamie-loring/Public-scripts/main/p10k-jamie-config.zsh -O "${TEMP_HOME}/.p10k.zsh" 2>/dev/null || log_warn "Failed to download p10k config"

cp -r "$TEMP_HOME"/.oh-my-zsh "$USER_HOME/" 2>/dev/null || true
cp "$TEMP_HOME"/.p10k.zsh "$USER_HOME/" 2>/dev/null || true
chown -R "$USERNAME":"$USERNAME" "$USER_HOME/.oh-my-zsh" "$USER_HOME/.p10k.zsh" 2>/dev/null || true
rm -rf "$TEMP_HOME"

# ============================================
# PHASE 4: TOOLS INSTALLATION
# ============================================
log_progress "Phase 4: Installing Pentesting Tools"

mkdir -p "$USER_HOME"/tools/{wordlists,scripts,exploits,repos}

# Python tools
log_progress "Installing Python tools..."
pip3 install --break-system-packages impacket 2>&1 | tee -a /var/log/ctfbox-install.log || pip3 install impacket

if ! command -v pipx &> /dev/null; then
  apt install -y pipx
fi
pipx ensurepath
pipx install git+https://github.com/Pennyw0rth/NetExec 2>&1 | tee -a /var/log/ctfbox-install.log || log_warn "NetExec install failed"
pipx install ldapdomaindump 2>&1 | tee -a /var/log/ctfbox-install.log || log_warn "ldapdomaindump install failed"
pipx install sprayhound 2>&1 | tee -a /var/log/ctfbox-install.log || log_warn "sprayhound install failed"

pip3 install --break-system-packages \
  hashid featherduster bloodhound bloodyAD mitm6 responder \
  certipy-ad coercer pypykatz lsassy enum4linux-ng dnsrecon \
  git-dumper roadrecon manspider mitmproxy pwntools ROPgadget \
  truffleHog 2>&1 | tee -a /var/log/ctfbox-install.log || true

# Go tools
if command -v go &> /dev/null; then
  log_progress "Installing Go tools..."
  export GOPATH="$USER_HOME/go"
  mkdir -p "$GOPATH/bin"
  
  bash -c "go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest && \
    go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest && \
    go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest && \
    go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest && \
    go install -v github.com/projectdiscovery/katana/cmd/katana@latest && \
    go install -v github.com/projectdiscovery/dnsx/cmd/dnsx@latest && \
    go install -v github.com/ffuf/ffuf@latest && \
    go install -v github.com/OJ/gobuster/v3@latest && \
    go install -v github.com/ropnop/kerbrute@latest && \
    go install -v github.com/jpillora/chisel@latest && \
    go install -v github.com/epi052/feroxbuster/v2@latest && \
    go install -v github.com/bp0lr/gauplus@latest && \
    go install -v github.com/ropnop/windapsearch@latest && \
    go install -v github.com/garrettfoster13/pre2k@latest && \
    go install -v github.com/nicocha30/ligolo-ng/cmd/proxy@latest && \
    go install -v github.com/nicocha30/ligolo-ng/cmd/agent@latest" \
    2>&1 | tee -a /var/log/ctfbox-install.log || true
fi

# Ruby tools
if command -v gem &> /dev/null; then
  log_progress "Installing Ruby tools..."
  gem install one_gadget haiti-hash evil-winrm 2>&1 | tee -a /var/log/ctfbox-install.log || true
fi

# System packages
log_progress "Installing system packages..."
DEBIAN_FRONTEND=noninteractive apt install -y \
  aircrack-ng bluez socat rlwrap proxychains4 sshuttle \
  steghide zsteg binwalk foremost exiftool p7zip-full \
  gdb radare2 2>&1 | tee -a /var/log/ctfbox-install.log || true

# Ysoserial
if [[ ! -f "$USER_HOME/tools/ysoserial.jar" ]] && command -v java &> /dev/null; then
  wget -q https://github.com/frohoff/ysoserial/releases/latest/download/ysoserial-all.jar -O "$USER_HOME/tools/ysoserial.jar" 2>/dev/null || log_warn "Failed to download ysoserial"
fi

# ============================================
# PHASE 5: WORDLISTS
# ============================================
log_progress "Phase 5: Downloading Wordlists (~700MB)"

if [[ ! -d "$USER_HOME/tools/wordlists/SecLists" ]]; then
  git clone --depth 1 https://github.com/danielmiessler/SecLists.git "$USER_HOME/tools/wordlists/SecLists" 2>&1 | tee -a /var/log/ctfbox-install.log || log_warn "SecLists clone failed"
fi

if [[ -f "/usr/share/wordlists/rockyou.txt.gz" ]] && [[ ! -f "/usr/share/wordlists/rockyou.txt" ]]; then
  gunzip /usr/share/wordlists/rockyou.txt.gz
fi

ln -sf "$USER_HOME/tools/wordlists/SecLists" "$USER_HOME/SecLists" 2>/dev/null || true
ln -sf /usr/share/wordlists/rockyou.txt "$USER_HOME/tools/wordlists/rockyou.txt" 2>/dev/null || true

# ============================================
# PHASE 6: REPOSITORIES
# ============================================
log_progress "Phase 6: Cloning Essential Repositories"

clone_repo() {
  local url="$1"
  local name=$(basename "$url" .git)
  if [[ ! -d "$USER_HOME/tools/repos/$name" ]]; then
    git clone "$url" "$USER_HOME/tools/repos/$name" 2>&1 | tee -a /var/log/ctfbox-install.log || log_warn "Failed to clone $name"
  fi
}

clone_repo "https://github.com/swisskyrepo/PayloadsAllTheThings.git"
clone_repo "https://github.com/peass-ng/PEASS-ng.git"
clone_repo "https://github.com/HackTricks-wiki/HackTricks.git"
clone_repo "https://github.com/Tib3rius/AutoRecon.git"
clone_repo "https://github.com/fortra/impacket.git"
clone_repo "https://github.com/projectdiscovery/nuclei-templates.git"
clone_repo "https://github.com/internetwache/GitTools.git"
clone_repo "https://github.com/AonCyberLabs/Windows-Exploit-Suggester.git"
clone_repo "https://github.com/PowerShellMafia/PowerSploit.git"
clone_repo "https://github.com/GTFOBins/GTFOBins.github.io.git"
clone_repo "https://github.com/LOLBAS-Project/LOLBAS.git"
clone_repo "https://github.com/RsaCtfTool/RsaCtfTool.git"
clone_repo "https://github.com/brightio/penelope.git"

# Create symlinks
ln -sf "$USER_HOME/tools/repos/PEASS-ng/linPEAS/linpeas.sh" "$USER_HOME/linpeas.sh" 2>/dev/null || true
ln -sf "$USER_HOME/tools/repos/PEASS-ng/winPEAS/winPEASx64.exe" "$USER_HOME/winpeas.exe" 2>/dev/null || true
ln -sf "$USER_HOME/tools/repos/penelope/penelope.py" "$USER_HOME/penelope.py" 2>/dev/null || true

# ============================================
# PHASE 6.5: FIREFOX EXTENSIONS
# ============================================
log_progress "Phase 6.5: Installing Firefox Extensions"

FIREFOX_PROFILE=$(find "$USER_HOME/.mozilla/firefox" -maxdepth 1 -type d -name "*.default*" 2>/dev/null | head -n 1)

if [[ -z "$FIREFOX_PROFILE" ]]; then
  log_warn "Firefox profile not found. Creating profile for $USERNAME..."
  su - "$USERNAME" -c "timeout 5 firefox --headless" 2>/dev/null || true
  sleep 2
  FIREFOX_PROFILE=$(find "$USER_HOME/.mozilla/firefox" -maxdepth 1 -type d -name "*.default*" 2>/dev/null | head -n 1)
fi

if [[ -n "$FIREFOX_PROFILE" ]]; then
  log_info "Firefox profile: $FIREFOX_PROFILE"
  mkdir -p "$FIREFOX_PROFILE/extensions"
  
  wget -q "https://addons.mozilla.org/firefox/downloads/latest/foxyproxy-standard/latest.xpi" \
    -O "$FIREFOX_PROFILE/extensions/foxyproxy@eric.h.jung.xpi" 2>/dev/null || log_warn "Failed: FoxyProxy"
  
  wget -q "https://addons.mozilla.org/firefox/downloads/latest/darkreader/latest.xpi" \
    -O "$FIREFOX_PROFILE/extensions/addon@darkreader.org.xpi" 2>/dev/null || log_warn "Failed: Dark Reader"
  
  wget -q "https://addons.mozilla.org/firefox/downloads/latest/cookie-editor/latest.xpi" \
    -O "$FIREFOX_PROFILE/extensions/{c5f15d22-8421-4a2f-9bed-e4e2c0b560e0}.xpi" 2>/dev/null || log_warn "Failed: Cookie-Editor"
  
  wget -q "https://addons.mozilla.org/firefox/downloads/latest/wappalyzer/latest.xpi" \
    -O "$FIREFOX_PROFILE/extensions/wappalyzer@crunchlabs.com.xpi" 2>/dev/null || log_warn "Failed: Wappalyzer"
  
  chown -R "$USERNAME":"$USERNAME" "$FIREFOX_PROFILE" 2>/dev/null || true
  log_info "Firefox extensions installed"
else
  log_warn "Could not create Firefox profile"
fi

# ============================================
# PHASE 7: DOTFILES & SCRIPTS
# ============================================
log_progress "Phase 7: Creating Dotfiles & Scripts"

mkdir -p "$USER_HOME/scripts"

# .zshrc
cat > "$USER_HOME/.zshrc" << 'ZSH_EOF'
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"
plugins=(git zsh-autosuggestions zsh-syntax-highlighting docker sudo history command-not-found)
source $ZSH/oh-my-zsh.sh
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

export PATH=$PATH:$HOME/go/bin:$HOME/.local/bin
export EDITOR=vim
export GOPATH=$HOME/go

command -v zoxide >/dev/null && eval "$(zoxide init zsh)"

# Auto-update nuclei templates (silent, in background)
command -v nuclei >/dev/null && nuclei -update-templates -silent &>/dev/null &

# System aliases
alias ll='ls -lah'
alias ...='cd ../..'
alias c='clear'
alias h='history'
alias please='sudo'
alias rl='rlwrap nc'

# Pentesting aliases
alias nmap-quick='nmap -sV -sC -O'
alias nmap-full='nmap -sV -sC -O -p-'
alias nmap-udp='nmap -sU -sV'
alias serve='python3 -m http.server'
alias serve80='sudo python3 -m http.server 80'
alias myip='curl -s ifconfig.me && echo'
alias ports='netstat -tulanp'
alias listening='lsof -i -P -n | grep LISTEN'
alias hash='hashid'
alias shell='python3 ~/penelope.py'

# Tool shortcuts
alias nxc='netexec'
alias cme='netexec'
alias smb='netexec smb'
alias winrm='netexec winrm'
alias bloodhound='bloodhound-python'
alias peas='linpeas.sh'
alias ysoserial='java -jar ~/tools/ysoserial.jar'
alias evil='evil-winrm'
alias ldump='ldapdomaindump'

# Impacket shortcuts
alias secretsdump='secretsdump.py'
alias getnpusers='GetNPUsers.py'
alias getuserspns='GetUserSPNs.py'
alias psexec='psexec.py'
alias smbexec='smbexec.py'
alias wmiexec='wmiexec.py'
alias ntlmrelayx='ntlmrelayx.py'
alias rpcclient='rpcclient.py'

# Wordlist shortcuts
alias wl-common='~/tools/wordlists/SecLists/Discovery/Web-Content/common.txt'
alias wl-dir='~/tools/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt'
alias wl-users='~/tools/wordlists/SecLists/Usernames/Names/names.txt'
alias wl-pass='~/tools/wordlists/rockyou.txt'
alias wl-params='~/tools/wordlists/SecLists/Discovery/Web-Content/burp-parameter-names.txt'

# Chisel shortcuts
alias chisel-server='chisel server --reverse --port 8000'
alias chisel-client='chisel client'

# Combo attacks
alias mitm-relay='sudo mitm6 -d DOMAIN & ntlmrelayx.py -t ldaps://DC-IP -wh attacker-ip --delegate-access'

# Navigation
alias tools='cd ~/tools'
alias repos='cd ~/tools/repos'
alias wordlists='cd ~/tools/wordlists'
alias scripts='cd ~/tools/scripts'
alias engagements='cd ~/engagements'

# Functions
newengagement() {
  [[ -z "$1" ]] && echo "Usage: newengagement <name>" && return 1
  mkdir -p ~/engagements/$1/{recon,scans,exploits,loot,notes,screenshots}
  cd ~/engagements/$1
  echo "# $1 Engagement" > notes/README.md
  echo "Created: $1"
  ls -la
}

quickscan() {
  [[ -z "$1" ]] && echo "Usage: quickscan <target>" && return 1
  nmap -sV -sC -O -oA quickscan_$(date +%Y%m%d_%H%M%S) $1
}

extract() {
  if [[ -f $1 ]]; then
    case $1 in
      *.tar.bz2) tar xjf $1 ;;
      *.tar.gz)  tar xzf $1 ;;
      *.bz2)     bunzip2 $1 ;;
      *.rar)     unrar e $1 ;;
      *.gz)      gunzip $1 ;;
      *.tar)     tar xf $1 ;;
      *.tbz2)    tar xjf $1 ;;
      *.tgz)     tar xzf $1 ;;
      *.zip)     unzip $1 ;;
      *.Z)       uncompress $1 ;;
      *.7z)      7z x $1 ;;
      *)         echo "'$1' cannot be extracted" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}
ZSH_EOF

# Update script
cat > "$USER_HOME/scripts/update-tools.sh" << 'UPDATE_EOF'
#!/bin/bash
echo "[+] Updating system..."
sudo apt update && sudo apt upgrade -y

echo "[+] Updating Python tools..."
pip3 install --upgrade --break-system-packages \
  impacket bloodhound bloodyAD certipy-ad pypykatz lsassy pwntools ROPgadget truffleHog || true

echo "[+] Updating Go tools..."
go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
go install -v github.com/ffuf/ffuf@latest
go install -v github.com/OJ/gobuster/v3@latest
go install -v github.com/jpillora/chisel@latest
go install -v github.com/epi052/feroxbuster/v2@latest
go install -v github.com/bp0lr/gauplus@latest
go install -v github.com/ropnop/windapsearch@latest
go install -v github.com/garrettfoster13/pre2k@latest
go install -v github.com/nicocha30/ligolo-ng/cmd/proxy@latest
go install -v github.com/nicocha30/ligolo-ng/cmd/agent@latest

echo "[+] Updating nuclei templates..."
nuclei -update-templates

echo "[+] Updating Ruby tools..."
gem update one_gadget haiti-hash evil-winrm || true

echo "[+] Updating pipx tools..."
pipx upgrade-all || true

echo "[+] Updating repositories..."
cd ~/tools/repos
for dir in */; do
  echo "[*] Updating $dir"
  cd "$dir" && git pull && cd ..
done

echo "[+] Done!"
UPDATE_EOF
chmod +x "$USER_HOME/scripts/update-tools.sh"

# Reset script
mkdir -p "$USER_HOME/Desktop"
cat > "$USER_HOME/Desktop/RESET_CTF_BOX.sh" << 'RESET_EOF'
#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}CTF BOX RESET SCRIPT${NC}\n"
echo -e "${YELLOW}This will:${NC}"
echo "  * Archive engagement folders"
echo "  * Reset /etc/hosts"
echo "  * Clear Kerberos tickets"
echo "  * Clear command history"
echo "  * Clear cached credentials"
echo "  * Clear SSH known hosts"
echo ""
read -p "Continue? (yes/no): " confirm
[[ "$confirm" != "yes" ]] && exit 0

ARCHIVE_DIR="$HOME/archives/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$ARCHIVE_DIR"

# Archive engagements
if [[ -d "$HOME/engagements" ]] && [[ "$(ls -A $HOME/engagements 2>/dev/null)" ]]; then
  tar -czf "$ARCHIVE_DIR/engagements_backup.tar.gz" -C "$HOME" engagements 2>/dev/null
  rm -rf "$HOME/engagements"/*
  echo -e "${GREEN}[+]${NC} Engagements archived"
fi

# Reset /etc/hosts
sudo cp /etc/hosts "$ARCHIVE_DIR/hosts.backup" 2>/dev/null
sudo bash -c "cat > /etc/hosts << 'EOF'
127.0.0.1       localhost
127.0.1.1       $(hostname)
::1     localhost ip6-localhost ip6-loopback
EOF"
echo -e "${GREEN}[+]${NC} /etc/hosts reset"

# Clear Kerberos
kdestroy -A 2>/dev/null || true
rm -f /tmp/krb5cc_* 2>/dev/null || true
echo -e "${GREEN}[+]${NC} Kerberos cleared"

# Clear history
[[ -f "$HOME/.bash_history" ]] && cat /dev/null > "$HOME/.bash_history"
[[ -f "$HOME/.zsh_history" ]] && cat /dev/null > "$HOME/.zsh_history"
history -c 2>/dev/null || true
echo -e "${GREEN}[+]${NC} History cleared"

# Clear creds
rm -rf "$HOME/.responder"/* "$HOME/.nxc"/* "$HOME/.cme"/* 2>/dev/null || true
echo -e "${GREEN}[+]${NC} Cached credentials cleared"

# Clear SSH
[[ -f "$HOME/.ssh/known_hosts" ]] && cat /dev/null > "$HOME/.ssh/known_hosts"
echo -e "${GREEN}[+]${NC} SSH known hosts cleared"

echo ""
echo -e "${GREEN}[+] RESET COMPLETE!${NC}"
echo -e "Archive: ${CYAN}$ARCHIVE_DIR${NC}\n"

read -p "Reboot now? (y/n): " reboot_choice
[[ "$reboot_choice" =~ ^[Yy]$ ]] && sudo reboot
RESET_EOF
chmod +x "$USER_HOME/Desktop/RESET_CTF_BOX.sh"

# ============================================
# PHASE 8: DOCUMENTATION
# ============================================
log_progress "Phase 8: Creating Desktop Documentation"

cat > "$USER_HOME/Desktop/COMMANDS.txt" << 'DOC_COMMANDS_EOF'
CTF Box Quick Command Reference
-----------------------------------------

I. CUSTOM FUNCTIONS
-------------------
newengagement <n>       Creates engagement folder structure
quickscan <target>      Quick Nmap scan with timestamp
extract <file>          Universal archive extraction

II. GENERAL ALIASES
-------------------
ll                      ls -lah
...                     cd ../..
please                  sudo
rl                      rlwrap nc

III. PENTESTING ALIASES
-----------------------
nmap-quick              nmap -sV -sC -O
nmap-full               nmap -sV -sC -O -p-
nmap-udp                nmap -sU -sV
serve                   python3 -m http.server
serve80                 sudo python3 -m http.server 80
myip                    curl -s ifconfig.me
hash                    hashid
shell                   python3 ~/penelope.py

IV. WINDOWS / AD ALIASES
--------------------------
nxc                     netexec
cme                     netexec (legacy alias)
smb                     netexec smb
winrm                   netexec winrm
evil                    evil-winrm
bloodhound              bloodhound-python
peas                    linpeas.sh
ldump                   ldapdomaindump

V. IMPACKET ALIASES
---------------------
secretsdump             secretsdump.py
getnpusers              GetNPUsers.py
getuserspns             GetUserSPNs.py
psexec                  psexec.py
smbexec                 smbexec.py
wmiexec                 wmiexec.py
ntlmrelayx              ntlmrelayx.py
rpcclient               rpcclient.py

VI. WORDLIST SHORTCUTS
----------------------
wl-common               Common web directories
wl-dir                  Directory list 2.3 medium
wl-users                Username list
wl-pass                 rockyou.txt
wl-params               Parameter names list

VII. CHISEL SHORTCUTS
---------------------
chisel-server           Start chisel server on 8000
chisel-client           Chisel client command

VIII. COMBO ATTACKS
-------------------
mitm-relay              mitm6 + ntlmrelayx combo
DOC_COMMANDS_EOF

cat > "$USER_HOME/Desktop/TOOL_LOCATIONS.txt" << TOOL_LOCATIONS_EOF
CTF Box Tool Location & Environment Reference
------------------------------------------------------------

I. USER ENVIRONMENT
-------------------
USER:       $USERNAME
HOME:       $USER_HOME
GOPATH:     $USER_HOME/go
SUDO:       NOPASSWD configured

II. TOOL DIRECTORY STRUCTURE
----------------------------
~/tools/
|-- repos/              (GitHub clones)
|-- wordlists/          (SecLists, rockyou.txt)
|-- scripts/            (Automation scripts)
|-- ysoserial.jar       (Java deserialization)

III. INSTALLED TOOLS
--------------------
Web Enumeration:
  - ffuf, feroxbuster, gobuster
  - httpx, nuclei (auto-updates templates)
  - subfinder, katana, dnsx
  - gauplus (wayback mining)

Windows/AD:
  - NetExec (nxc/cme)
  - evil-winrm
  - Impacket suite
  - kerbrute, windapsearch, pre2k
  - ldapdomaindump, sprayhound
  - bloodhound-python

Pivoting/Tunneling:
  - chisel, ligolo-ng
  - proxychains4, sshuttle

Post-Exploitation:
  - Penelope (reverse shell handler)
  - linPEAS, winPEAS

IV. TOOL ACCESS
----------------
* Go Tools: \$HOME/go/bin/
* Python Tools: Global or pipx
* Ruby Tools: evil-winrm, one_gadget
* Impacket: Use aliases (secretsdump, etc)

V. KEY FILES
-------------
Shell Config:       ~/.zshrc and ~/.p10k.zsh
Update Script:      ~/scripts/update-tools.sh 
System Reset:       ~/Desktop/RESET_CTF_BOX.sh

VI. ENVIRONMENT VARIABLES
------------------------
GOPATH=$USER_HOME/go
PATH includes:
  - \$HOME/go/bin
  - \$HOME/.local/bin
  - Pipx bins
  - Impacket scripts
TOOL_LOCATIONS_EOF

chown "$USERNAME":"$USERNAME" "$USER_HOME/Desktop"/*.txt 2>/dev/null || true

# ============================================
# PHASE 8.5: DISABLE ORIGINAL USER
# ============================================
if [[ -n "$ORIGINAL_USER" ]] && [[ "$ORIGINAL_USER" != "$USERNAME" ]] && id "$ORIGINAL_USER" &>/dev/null; then
  echo ""
  read -p "Disable original user '$ORIGINAL_USER'? (y/n): " disable_old
  if [[ "$disable_old" =~ ^[Yy]$ ]]; then
    log_progress "Phase 8.5: Disabling Original User Account"
    
    log_progress "Locking password for $ORIGINAL_USER..."
    usermod -L "$ORIGINAL_USER" 2>&1 | tee -a /var/log/ctfbox-install.log
    
    log_progress "Setting shell to /usr/sbin/nologin..."
    usermod -s /usr/sbin/nologin "$ORIGINAL_USER" 2>&1 | tee -a /var/log/ctfbox-install.log
    
    log_progress "Removing from sudo group..."
    deluser "$ORIGINAL_USER" sudo 2>/dev/null || true
    
    log_info "User '$ORIGINAL_USER' has been disabled"
  fi
fi

# ============================================
# FINAL CLEANUP
# ============================================
log_progress "Phase 9: Final Cleanup"

chown -R "$USERNAME":"$USERNAME" "$USER_HOME" 2>/dev/null || true
apt autoremove -y -qq 2>/dev/null || true
apt clean -qq 2>/dev/null || true

# ============================================
# COMPLETION
# ============================================
clear
echo -e "${GREEN}"
cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ðŸŽ‰ CTF BOX INSTALLATION COMPLETE! ðŸŽ‰                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}\n"

echo -e "${YELLOW}User:${NC} ${GREEN}$USERNAME${NC}"
echo -e "${YELLOW}Home:${NC} ${GREEN}$USER_HOME${NC}"
[[ -n "$ORIGINAL_USER" ]] && [[ "$ORIGINAL_USER" != "$USERNAME" ]] && echo -e "${YELLOW}Original User:${NC} ${RED}$ORIGINAL_USER (disabled)${NC}"
echo ""
echo -e "${CYAN}Documentation:${NC}"
echo "  - Commands: ${CYAN}~/Desktop/COMMANDS.txt${NC}"
echo "  - Locations: ${CYAN}~/Desktop/TOOL_LOCATIONS.txt${NC}"
echo ""
echo -e "${CYAN}Firefox Extensions:${NC}"
echo "  - FoxyProxy, Dark Reader, Cookie-Editor, Wappalyzer"
echo -e "${CYAN}Quick Start:${NC}"
echo "  - Update tools: ${CYAN}~/scripts/update-tools.sh${NC}"
echo "  - Reset system: ${CYAN}~/Desktop/RESET_CTF_BOX.sh${NC}"
echo "  - New engagement: ${CYAN}newengagement <name>${NC}"
echo ""

read -p "Reboot now? (y/n): " reboot_choice
if [[ "$reboot_choice" =~ ^[Yy]$ ]]; then
  echo -e "\n${YELLOW}Rebooting in 5 seconds...${NC}"
  sleep 5
  reboot
fi

echo -e "${GREEN}Happy Hacking! ðŸš€${NC}\n"
